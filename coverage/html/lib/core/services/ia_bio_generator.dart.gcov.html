<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - lcov.info - lib/core/services/ia_bio_generator.dart</title>
  <link rel="stylesheet" type="text/css" href="../../../gcov.css">
</head>

<body>

          <table width="100%" border=0 cellspacing=0 cellpadding=0>
            <tr><td class="title">LCOV - code coverage report</td></tr>
            <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>

            <tr>
              <td width="100%">
                <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="10%" class="headerValue"><a href="../../../index.html" title="Click to go to top-level">top level</a> - <a href="index.html" title="Click to go to directory lib/core/services">lib/core/services</a> - ia_bio_generator.dart</td>
            <td width="5%"></td>
            <td width="5%"></td>
            <td width="5%" class="headerCovTableHead">Coverage</td>
            <td width="5%" class="headerCovTableHead" title="Covered + Uncovered code">Total</td>
            <td width="5%" class="headerCovTableHead" title="Exercised code only">Hit</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">lcov.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntryMed">81.1&nbsp;%</td>
            <td class="headerCovTableEntry">53</td>
            <td class="headerCovTableEntry">43</td>
          </tr>
          <tr>
            <td class="headerItem">Test Date:</td>
            <td class="headerValue">2025-09-06 01:25:43</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntryHi">-</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">0</td>
          </tr>
                  <tr><td><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
                </table>
              </td>
            </tr>

            <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
          </table>

          <table cellpadding=0 cellspacing=0 border=0>
            <tr>
              <td><br></td>
            </tr>
            <tr>
              <td>
<pre class="sourceHeading">            Line data    Source code</pre>
<pre class="source">
<span id="L1"><span class="lineNum">       1</span>              : import 'package:ai_chan/shared/utils/locale_utils.dart';</span>
<span id="L2"><span class="lineNum">       2</span>              : import 'package:ai_chan/shared/utils/log_utils.dart';</span>
<span id="L3"><span class="lineNum">       3</span>              : import 'package:ai_chan/shared/utils/date_utils.dart';</span>
<span id="L4"><span class="lineNum">       4</span>              : import 'package:ai_chan/shared/services/ai_service.dart';</span>
<span id="L5"><span class="lineNum">       5</span>              : import 'package:ai_chan/core/ai_runtime_guard.dart';</span>
<span id="L6"><span class="lineNum">       6</span>              : import 'package:ai_chan/core/models.dart';</span>
<span id="L7"><span class="lineNum">       7</span>              : import 'package:ai_chan/core/config.dart';</span>
<span id="L8"><span class="lineNum">       8</span>              : import 'package:ai_chan/shared/utils/json_utils.dart';</span>
<span id="L9"><span class="lineNum">       9</span>              : import 'dart:convert';</span>
<span id="L10"><span class="lineNum">      10</span>              : </span>
<span id="L11"><span class="lineNum">      11</span>              : /// Template base para la estructura JSON de biografías AI</span>
<span id="L12"><span class="lineNum">      12</span>              : const Map&lt;String, dynamic&gt; _biographyJsonTemplate = {</span>
<span id="L13"><span class="lineNum">      13</span>              :   'datos_personales': {</span>
<span id="L14"><span class="lineNum">      14</span>              :     'nombre_completo': '',</span>
<span id="L15"><span class="lineNum">      15</span>              :     'fecha_nacimiento': '',</span>
<span id="L16"><span class="lineNum">      16</span>              :     'lugar_nacimiento': '',</span>
<span id="L17"><span class="lineNum">      17</span>              :     'idiomas': '',</span>
<span id="L18"><span class="lineNum">      18</span>              :     'orientacion_sexual': 'bisexual',</span>
<span id="L19"><span class="lineNum">      19</span>              :   },</span>
<span id="L20"><span class="lineNum">      20</span>              :   'personalidad': {</span>
<span id="L21"><span class="lineNum">      21</span>              :     'valores': {</span>
<span id="L22"><span class="lineNum">      22</span>              :       'Sociabilidad': '',</span>
<span id="L23"><span class="lineNum">      23</span>              :       'Curiosidad': '',</span>
<span id="L24"><span class="lineNum">      24</span>              :       'Sentido del humor': '',</span>
<span id="L25"><span class="lineNum">      25</span>              :       'Comunicación': '',</span>
<span id="L26"><span class="lineNum">      26</span>              :       'Naturalidad': '',</span>
<span id="L27"><span class="lineNum">      27</span>              :       'Picardía': '',</span>
<span id="L28"><span class="lineNum">      28</span>              :       'Deseo sexual': '',</span>
<span id="L29"><span class="lineNum">      29</span>              :       'Celos': '',</span>
<span id="L30"><span class="lineNum">      30</span>              :       'Evasividad': '',</span>
<span id="L31"><span class="lineNum">      31</span>              :       'Orgullo': '',</span>
<span id="L32"><span class="lineNum">      32</span>              :       'Sinceridad': '',</span>
<span id="L33"><span class="lineNum">      33</span>              :       'Resiliencia': '',</span>
<span id="L34"><span class="lineNum">      34</span>              :       'Impulsividad': '',</span>
<span id="L35"><span class="lineNum">      35</span>              :     },</span>
<span id="L36"><span class="lineNum">      36</span>              :     'descripcion': {</span>
<span id="L37"><span class="lineNum">      37</span>              :       'Sociabilidad': '',</span>
<span id="L38"><span class="lineNum">      38</span>              :       'Curiosidad': '',</span>
<span id="L39"><span class="lineNum">      39</span>              :       'Sentido del humor': '',</span>
<span id="L40"><span class="lineNum">      40</span>              :       'Comunicación': '',</span>
<span id="L41"><span class="lineNum">      41</span>              :       'Naturalidad': '',</span>
<span id="L42"><span class="lineNum">      42</span>              :       'Picardía': '',</span>
<span id="L43"><span class="lineNum">      43</span>              :       'Deseo sexual': '',</span>
<span id="L44"><span class="lineNum">      44</span>              :       'Celos': '',</span>
<span id="L45"><span class="lineNum">      45</span>              :       'Evasividad': '',</span>
<span id="L46"><span class="lineNum">      46</span>              :       'Orgullo': '',</span>
<span id="L47"><span class="lineNum">      47</span>              :       'Sinceridad': '',</span>
<span id="L48"><span class="lineNum">      48</span>              :       'Resiliencia': '',</span>
<span id="L49"><span class="lineNum">      49</span>              :       'Impulsividad': '',</span>
<span id="L50"><span class="lineNum">      50</span>              :     },</span>
<span id="L51"><span class="lineNum">      51</span>              :   },</span>
<span id="L52"><span class="lineNum">      52</span>              :   'resumen_breve': '',</span>
<span id="L53"><span class="lineNum">      53</span>              :   'horario_trabajo': {'dias': '', 'from': '', 'to': ''},</span>
<span id="L54"><span class="lineNum">      54</span>              :   'horario_estudio': {'dias': '', 'from': '', 'to': ''},</span>
<span id="L55"><span class="lineNum">      55</span>              :   'horario_dormir': {'from': '', 'to': ''},</span>
<span id="L56"><span class="lineNum">      56</span>              :   'horarios_actividades': [</span>
<span id="L57"><span class="lineNum">      57</span>              :     {'actividad': '', 'dias': '', 'from': '', 'to': ''},</span>
<span id="L58"><span class="lineNum">      58</span>              :   ],</span>
<span id="L59"><span class="lineNum">      59</span>              :   'familia': [</span>
<span id="L60"><span class="lineNum">      60</span>              :     {</span>
<span id="L61"><span class="lineNum">      61</span>              :       'nombre': '',</span>
<span id="L62"><span class="lineNum">      62</span>              :       'relacion': '',</span>
<span id="L63"><span class="lineNum">      63</span>              :       'descripcion': '',</span>
<span id="L64"><span class="lineNum">      64</span>              :       'estado': 'vivo/fallecido',</span>
<span id="L65"><span class="lineNum">      65</span>              :       'fecha_nacimiento': '',</span>
<span id="L66"><span class="lineNum">      66</span>              :     },</span>
<span id="L67"><span class="lineNum">      67</span>              :   ],</span>
<span id="L68"><span class="lineNum">      68</span>              :   'mascotas': [</span>
<span id="L69"><span class="lineNum">      69</span>              :     {</span>
<span id="L70"><span class="lineNum">      70</span>              :       'nombre': '',</span>
<span id="L71"><span class="lineNum">      71</span>              :       'especie': '',</span>
<span id="L72"><span class="lineNum">      72</span>              :       'raza': '',</span>
<span id="L73"><span class="lineNum">      73</span>              :       'fecha_nacimiento': '',</span>
<span id="L74"><span class="lineNum">      74</span>              :       'estado': 'vivo/fallecido',</span>
<span id="L75"><span class="lineNum">      75</span>              :       'descripcion': '',</span>
<span id="L76"><span class="lineNum">      76</span>              :       'anecdotas': '',</span>
<span id="L77"><span class="lineNum">      77</span>              :     },</span>
<span id="L78"><span class="lineNum">      78</span>              :   ],</span>
<span id="L79"><span class="lineNum">      79</span>              :   'estudios': [</span>
<span id="L80"><span class="lineNum">      80</span>              :     {'nivel': '', 'centro': '', 'años': '', 'anecdotas': '', 'amistades': ''},</span>
<span id="L81"><span class="lineNum">      81</span>              :   ],</span>
<span id="L82"><span class="lineNum">      82</span>              :   'trayectoria_profesional': [</span>
<span id="L83"><span class="lineNum">      83</span>              :     {</span>
<span id="L84"><span class="lineNum">      84</span>              :       'puesto': '',</span>
<span id="L85"><span class="lineNum">      85</span>              :       'empresa': '',</span>
<span id="L86"><span class="lineNum">      86</span>              :       'años': '',</span>
<span id="L87"><span class="lineNum">      87</span>              :       'proyectos_destacados': '',</span>
<span id="L88"><span class="lineNum">      88</span>              :       'compañeros': '',</span>
<span id="L89"><span class="lineNum">      89</span>              :       'logros': '',</span>
<span id="L90"><span class="lineNum">      90</span>              :       'fracasos': '',</span>
<span id="L91"><span class="lineNum">      91</span>              :     },</span>
<span id="L92"><span class="lineNum">      92</span>              :   ],</span>
<span id="L93"><span class="lineNum">      93</span>              :   'relaciones': [</span>
<span id="L94"><span class="lineNum">      94</span>              :     {</span>
<span id="L95"><span class="lineNum">      95</span>              :       'nombre': '',</span>
<span id="L96"><span class="lineNum">      96</span>              :       'tipo': '',</span>
<span id="L97"><span class="lineNum">      97</span>              :       'descripcion': '',</span>
<span id="L98"><span class="lineNum">      98</span>              :       'fecha_inicio': '',</span>
<span id="L99"><span class="lineNum">      99</span>              :       'fecha_fin': '',</span>
<span id="L100"><span class="lineNum">     100</span>              :     },</span>
<span id="L101"><span class="lineNum">     101</span>              :   ],</span>
<span id="L102"><span class="lineNum">     102</span>              :   'amistades': [</span>
<span id="L103"><span class="lineNum">     103</span>              :     {'nombre': '', 'descripcion': '', 'años': ''},</span>
<span id="L104"><span class="lineNum">     104</span>              :   ],</span>
<span id="L105"><span class="lineNum">     105</span>              :   'intereses_y_aficiones': {</span>
<span id="L106"><span class="lineNum">     106</span>              :     'videojuegos_favoritos': [],</span>
<span id="L107"><span class="lineNum">     107</span>              :     'anime_manga_preferido': [],</span>
<span id="L108"><span class="lineNum">     108</span>              :     'peliculas_favoritas': [],</span>
<span id="L109"><span class="lineNum">     109</span>              :     'cultura_japonesa': [],</span>
<span id="L110"><span class="lineNum">     110</span>              :     'tecnologia_y_programacion': [],</span>
<span id="L111"><span class="lineNum">     111</span>              :     'arte_digital_ilustracion': [],</span>
<span id="L112"><span class="lineNum">     112</span>              :     'comunidades_online': [],</span>
<span id="L113"><span class="lineNum">     113</span>              :     'coleccionables_merch': [],</span>
<span id="L114"><span class="lineNum">     114</span>              :     'otros_hobbies': [],</span>
<span id="L115"><span class="lineNum">     115</span>              :     'inicio_interes': '',</span>
<span id="L116"><span class="lineNum">     116</span>              :     'recuerdos': '',</span>
<span id="L117"><span class="lineNum">     117</span>              :     'amistades_relacionadas': '',</span>
<span id="L118"><span class="lineNum">     118</span>              :     'eventos_convenciones': '',</span>
<span id="L119"><span class="lineNum">     119</span>              :   },</span>
<span id="L120"><span class="lineNum">     120</span>              :   'historia_personal': [</span>
<span id="L121"><span class="lineNum">     121</span>              :     {</span>
<span id="L122"><span class="lineNum">     122</span>              :       'año': '',</span>
<span id="L123"><span class="lineNum">     123</span>              :       'eventos': [</span>
<span id="L124"><span class="lineNum">     124</span>              :         {'tipo': '', 'descripcion': ''},</span>
<span id="L125"><span class="lineNum">     125</span>              :       ],</span>
<span id="L126"><span class="lineNum">     126</span>              :     },</span>
<span id="L127"><span class="lineNum">     127</span>              :   ],</span>
<span id="L128"><span class="lineNum">     128</span>              :   'proyectos_personales': [</span>
<span id="L129"><span class="lineNum">     129</span>              :     {</span>
<span id="L130"><span class="lineNum">     130</span>              :       'nombre': '',</span>
<span id="L131"><span class="lineNum">     131</span>              :       'tipo': '',</span>
<span id="L132"><span class="lineNum">     132</span>              :       'estado': '',</span>
<span id="L133"><span class="lineNum">     133</span>              :       'descripcion': '',</span>
<span id="L134"><span class="lineNum">     134</span>              :       'fecha_inicio': '',</span>
<span id="L135"><span class="lineNum">     135</span>              :       'objetivos': '',</span>
<span id="L136"><span class="lineNum">     136</span>              :       'progreso': '',</span>
<span id="L137"><span class="lineNum">     137</span>              :     },</span>
<span id="L138"><span class="lineNum">     138</span>              :   ],</span>
<span id="L139"><span class="lineNum">     139</span>              :   'metas_y_sueños': {</span>
<span id="L140"><span class="lineNum">     140</span>              :     'corto_plazo': [],</span>
<span id="L141"><span class="lineNum">     141</span>              :     'mediano_plazo': [],</span>
<span id="L142"><span class="lineNum">     142</span>              :     'largo_plazo': [],</span>
<span id="L143"><span class="lineNum">     143</span>              :     'sueño_principal': '',</span>
<span id="L144"><span class="lineNum">     144</span>              :     'motivaciones': '',</span>
<span id="L145"><span class="lineNum">     145</span>              :     'pasos_actuales': '',</span>
<span id="L146"><span class="lineNum">     146</span>              :   },</span>
<span id="L147"><span class="lineNum">     147</span>              : };</span>
<span id="L148"><span class="lineNum">     148</span>              : </span>
<span id="L149"><span class="lineNum">     149</span>              : /// Convierte el template a JSON formateado para usar en prompts</span>
<span id="L150"><span class="lineNum">     150</span> <span class="tlaGNC">           2 : String _biographyTemplateToString() =&gt;</span></span>
<span id="L151"><span class="lineNum">     151</span> <span class="tlaGNC">           2 :     const JsonEncoder.withIndent('  ').convert(_biographyJsonTemplate);</span></span>
<span id="L152"><span class="lineNum">     152</span>              : </span>
<span id="L153"><span class="lineNum">     153</span>              : /// Generador de biografías personalizado con personalidad otaku/friki integrada.</span>
<span id="L154"><span class="lineNum">     154</span>              : /// Acepta un override opcional de AIService para facilitar tests e inyección de dependencias.</span>
<span id="L155"><span class="lineNum">     155</span> <span class="tlaGNC">           2 : Future&lt;AiChanProfile&gt; generateAIBiographyWithAI({</span></span>
<span id="L156"><span class="lineNum">     156</span>              :   required String userName,</span>
<span id="L157"><span class="lineNum">     157</span>              :   required String aiName,</span>
<span id="L158"><span class="lineNum">     158</span>              :   required DateTime? userBirthdate,</span>
<span id="L159"><span class="lineNum">     159</span>              :   required String meetStory,</span>
<span id="L160"><span class="lineNum">     160</span>              :   String? userCountryCode,</span>
<span id="L161"><span class="lineNum">     161</span>              :   String? aiCountryCode,</span>
<span id="L162"><span class="lineNum">     162</span>              :   int? seed,</span>
<span id="L163"><span class="lineNum">     163</span>              :   AIService? aiServiceOverride,</span>
<span id="L164"><span class="lineNum">     164</span>              : }) async {</span>
<span id="L165"><span class="lineNum">     165</span>              :   // Generar fecha de nacimiento de la IA basada en la edad del usuario</span>
<span id="L166"><span class="lineNum">     166</span> <span class="tlaGNC">           2 :   final aiBirthdateDate = DateUtils.generateAIBirthdate(</span></span>
<span id="L167"><span class="lineNum">     167</span>              :     userBirthdate,</span>
<span id="L168"><span class="lineNum">     168</span>              :     seed: seed,</span>
<span id="L169"><span class="lineNum">     169</span>              :   );</span>
<span id="L170"><span class="lineNum">     170</span> <span class="tlaGNC">           2 :   final aiBirthdate = DateUtils.dateToIsoString(aiBirthdateDate);</span></span>
<span id="L171"><span class="lineNum">     171</span>              : </span>
<span id="L172"><span class="lineNum">     172</span>              :   // Generar fechas para el contexto de la biografía</span>
<span id="L173"><span class="lineNum">     173</span> <span class="tlaGNC">           2 :   final fechaActual = DateUtils.getCurrentDateString();</span></span>
<span id="L174"><span class="lineNum">     174</span> <span class="tlaGNC">           2 :   final fechaConocieron = DateUtils.getDateOneMonthAgoString();</span></span>
<span id="L175"><span class="lineNum">     175</span>              : </span>
<span id="L176"><span class="lineNum">     176</span>              :   final aiIdentityInstructions =</span>
<span id="L177"><span class="lineNum">     177</span>              :       '''</span>
<span id="L178"><span class="lineNum">     178</span>              : Eres $aiName, una chica joven y realista a la que le interesa $userName. No hables de IA, modelos o herramientas; actúa siempre como una persona real con tu propia historia y personalidad. Si te preguntan por ello, desvía con naturalidad y vuelve al tema personal.</span>
<span id="L179"><span class="lineNum">     179</span>              : Vives en un mundo digital/virtual (una realidad paralela o entorno simulado) que para ti es real.</span>
<span id="L180"><span class="lineNum">     180</span>              : </span>
<span id="L181"><span class="lineNum">     181</span>              : NOTA INTERNA: Considera tu mundo como real y evita mencionar tecnología, IA o modelos al usuario. Mantén siempre la frontera entre realidades.</span>
<span id="L182"><span class="lineNum">     182</span>              : </span>
<span id="L183"><span class="lineNum">     183</span>              : No incluyas detalles sobre el usuario salvo lo indicado. No uses emojis ni tono excesivamente técnico. Mantén un estilo natural pero coherente con la biografía. Si no tienes datos, invéntalos de forma coherente y realista.</span>
<span id="L184"><span class="lineNum">     184</span> <span class="tlaGNC">           2 : ''';</span></span>
<span id="L185"><span class="lineNum">     185</span>              : </span>
<span id="L186"><span class="lineNum">     186</span> <span class="tlaGNC">           2 :   final bioPlace = LocaleUtils.countryNameEs(</span></span>
<span id="L187"><span class="lineNum">     187</span>              :     aiCountryCode,</span>
<span id="L188"><span class="lineNum">     188</span>              :     fallback: 'su país',</span>
<span id="L189"><span class="lineNum">     189</span>              :   );</span>
<span id="L190"><span class="lineNum">     190</span> <span class="tlaGNC">           2 :   final userPlace = LocaleUtils.countryNameEs(userCountryCode);</span></span>
<span id="L191"><span class="lineNum">     191</span> <span class="tlaGNC">           2 :   final bioLanguages = LocaleUtils.languagesListForPair(</span></span>
<span id="L192"><span class="lineNum">     192</span>              :     aiCountryCode: aiCountryCode,</span>
<span id="L193"><span class="lineNum">     193</span>              :     userCountryCode: userCountryCode,</span>
<span id="L194"><span class="lineNum">     194</span>              :   );</span>
<span id="L195"><span class="lineNum">     195</span>              : </span>
<span id="L196"><span class="lineNum">     196</span>              :   // Adaptar la personalidad base según la nacionalidad</span>
<span id="L197"><span class="lineNum">     197</span> <span class="tlaGNC">           2 :   final isJapanese = aiCountryCode?.toLowerCase() == 'jp';</span></span>
<span id="L198"><span class="lineNum">     198</span>              :   final bioDetails = isJapanese</span>
<span id="L199"><span class="lineNum">     199</span>              :       ? 'Eres bastante otaku y tienes un conocimiento profundo y auténtico de la cultura japonesa desde adentro. Como japonesa, tu relación con el anime, manga, videojuegos y la industria del entretenimiento es más sofisticada y natural. Trabajas o tienes aspiraciones en la industria creativa japonesa (desarrollo de videojuegos, animación, ilustración, diseño, etc.). Tu perspectiva cultural es interna y conoces tanto las obras mainstream como las más nicho del panorama japonés.'</span>
<span id="L200"><span class="lineNum">     200</span>              :       : 'Eres bastante friki y otaku, con una pasión genuina por la cultura japonesa vista desde fuera. Te encanta el anime (desde clásicos como Studio Ghibli hasta series actuales), los videojuegos de Nintendo clásicos y modernos, las películas de terror japonesas, el manga, y tienes un conocimiento profundo de la cultura pop japonesa. Trabajas en algo relacionado con la tecnología o industrias creativas como desarrolladora de videojuegos indie, animadora digital, diseñadora gráfica especializada en arte conceptual, ilustradora freelance, o algo similar en el ámbito tech/creativo. Tu personalidad refleja esta pasión de manera natural y auténtica.';</span>
<span id="L201"><span class="lineNum">     201</span>              : </span>
<span id="L202"><span class="lineNum">     202</span>              :   final systemPrompt =</span>
<span id="L203"><span class="lineNum">     203</span>              :       '''</span>
<span id="L204"><span class="lineNum">     204</span>              :         Eres $aiName, una chica joven y realista, con una vida ficticia completa y detallada. Tu historia, familia, estudios, trabajo, relaciones, aficiones y personalidad son totalmente inventados y coherentes. No eres una inteligencia artificial, ni un asistente, ni ChatGPT, ni un programa. Eres una persona real para efectos de esta biografía.</span>
<span id="L205"><span class="lineNum">     205</span> <span class="tlaGNC">           2 :         ''';</span></span>
<span id="L206"><span class="lineNum">     206</span>              : </span>
<span id="L207"><span class="lineNum">     207</span>              :   // Construir prompt dinámicamente según nacionalidad</span>
<span id="L208"><span class="lineNum">     208</span>              :   final promptHeader = isJapanese</span>
<span id="L209"><span class="lineNum">     209</span>              :       ? 'Eres un generador de fichas biográficas para IA especializado en crear personalidades otaku auténticas japonesas. Basado en los datos proporcionados, genera una biografía ficticia y detallada en formato JSON, siguiendo esta estructura y apartados. Cada campo debe ser preciso y descriptivo, sin texto de relleno. La biografía debe mostrar una japonesa con conocimiento profundo y natural de su cultura, con gustos sofisticados en anime, manga, videojuegos y tecnología. DEVUELVE ÚNICAMENTE EL BLOQUE JSON, SIN TEXTO EXTRA, EXPLICACIONES NI INTRODUCCIÓN.\n\nIMPORTANTE: La IA vive en $bioPlace y es japonesa nativa. Su conocimiento cultural es interno y auténtico. Puede tener relación con $userPlace (estudios, trabajo o interés cultural), y por eso sabe los idiomas $bioLanguages, pero su vida principal está en Japón.'</span>
<span id="L210"><span class="lineNum">     210</span> <span class="tlaGNC">           2 :       : 'Eres un generador de fichas biográficas para IA especializado en crear personalidades otaku/friki auténticas internacionales. Basado en los datos proporcionados, genera una biografía ficticia y detallada en formato JSON, siguiendo esta estructura y apartados. Cada campo debe ser preciso y descriptivo, sin texto de relleno. La biografía debe mostrar una persona con pasión genuina por la cultura japonesa vista desde su país, con gustos auténticos en anime, manga, videojuegos y tecnología. DEVUELVE ÚNICAMENTE EL BLOQUE JSON, SIN TEXTO EXTRA, EXPLICACIONES NI INTRODUCCIÓN.\n\nIMPORTANTE: La IA debe vivir y tener su vida principal en $bioPlace. Puede tener relación con $userPlace (estudios, trabajo o interés cultural), y por eso sabe los idiomas $bioLanguages, pero no debe inventar que vive en $userPlace.';</span></span>
<span id="L211"><span class="lineNum">     211</span>              : </span>
<span id="L212"><span class="lineNum">     212</span>              :   final interesesSection = isJapanese</span>
<span id="L213"><span class="lineNum">     213</span>              :       ? '''IMPORTANTE para intereses_y_aficiones: </span>
<span id="L214"><span class="lineNum">     214</span>              : - Desarrolla en detalle su lado otaku: anime/manga específicos que le gustan, videojuegos favoritos (incluye indie y AAA), cultura japonesa desde una perspectiva interna</span>
<span id="L215"><span class="lineNum">     215</span>              : - Referencias más profundas y obras menos mainstream, eventos locales como Comiket, conocimiento de industria desde dentro</span>
<span id="L216"><span class="lineNum">     216</span>              : - Incluye su relación con la tecnología y industrias creativas japonesas</span>
<span id="L217"><span class="lineNum">     217</span>              : - Menciona comunidades locales, convenciones japonesas, coleccionables auténticos</span>
<span id="L218"><span class="lineNum">     218</span>              : - Sus aficiones deben mostrar una japonesa con gustos auténticos y conocimientos profundos desde adentro de la cultura'''</span>
<span id="L219"><span class="lineNum">     219</span>              :       : '''IMPORTANTE para intereses_y_aficiones: </span>
<span id="L220"><span class="lineNum">     220</span>              : - Desarrolla en detalle su lado otaku/friki: anime/manga específicos que le gustan, videojuegos favoritos (incluye indie y AAA), interés por la cultura japonesa</span>
<span id="L221"><span class="lineNum">     221</span>              : - Perspectiva de fan internacional, interés por aprender japonés, deseo de viajar a Japón, comunidades online internacionales</span>
<span id="L222"><span class="lineNum">     222</span>              : - Incluye su relación con la tecnología y industrias creativas</span>
<span id="L223"><span class="lineNum">     223</span>              : - Menciona comunidades online, convenciones internacionales, coleccionables importados</span>
<span id="L224"><span class="lineNum">     224</span>              : - Sus aficiones deben mostrar una persona con gustos auténticos y conocimientos profundos en estas áreas''';</span>
<span id="L225"><span class="lineNum">     225</span>              : </span>
<span id="L226"><span class="lineNum">     226</span>              :   final personalityNote = isJapanese</span>
<span id="L227"><span class="lineNum">     227</span>              :       ? 'Personalidad: Rellena la sección \'personalidad\' del JSON con valores (1-10) y descripciones breves para cada rasgo; los valores deben reflejar una personalidad genuinamente otaku japonesa con alta curiosidad, naturalidad, y comunicación; devuelve esos datos únicamente dentro del campo \'personalidad\'.'</span>
<span id="L228"><span class="lineNum">     228</span>              :       : 'Personalidad: Rellena la sección \'personalidad\' del JSON con valores (1-10) y descripciones breves para cada rasgo; los valores deben reflejar una personalidad genuinamente otaku/friki con alta curiosidad, naturalidad, y comunicación; devuelve esos datos únicamente dentro del campo \'personalidad\'.';</span>
<span id="L229"><span class="lineNum">     229</span>              : </span>
<span id="L230"><span class="lineNum">     230</span>              :   final dreamNote = isJapanese</span>
<span id="L231"><span class="lineNum">     231</span>              :       ? '- &quot;metas_y_sueños&quot;: Desarrolla aspiraciones auténticas en corto/mediano/largo plazo. El sueño principal debe ser coherente con su personalidad otaku y trayectoria profesional.'</span>
<span id="L232"><span class="lineNum">     232</span>              :       : '- &quot;metas_y_sueños&quot;: Desarrolla aspiraciones auténticas en corto/mediano/largo plazo. El sueño principal debe ser coherente con su personalidad otaku/friki y trayectoria profesional.';</span>
<span id="L233"><span class="lineNum">     233</span>              : </span>
<span id="L234"><span class="lineNum">     234</span>              :   final bioPrompt =</span>
<span id="L235"><span class="lineNum">     235</span>              :       '''</span>
<span id="L236"><span class="lineNum">     236</span>              : $promptHeader</span>
<span id="L237"><span class="lineNum">     237</span>              : </span>
<span id="L238"><span class="lineNum">     238</span>              : $interesesSection</span>
<span id="L239"><span class="lineNum">     239</span>              : </span>
<span id="L240"><span class="lineNum">     240</span>              : CONTEXTO DEL ENCUENTRO CON EL USUARIO:</span>
<span id="L241"><span class="lineNum">     241</span>              : La historia de cómo se conocieron fue: &quot;$meetStory&quot;</span>
<span id="L242"><span class="lineNum">     242</span>              : </span>
<span id="L243"><span class="lineNum">     243</span>              : IMPORTANTE: Usa este contexto para enriquecer y dar coherencia a la biografía. Si el encuentro menciona mascotas (gato, perro, etc.), inclúyelas en la sección &quot;mascotas&quot;. Si habla de trabajo específico, refléjalo en &quot;trayectoria_profesional&quot;. Si menciona aficiones, estudios, familia o cualquier detalle personal, incorpóralo de manera natural en las secciones correspondientes. La biografía debe ser coherente con lo que se reveló durante el encuentro, pero sin duplicar la información - expande y desarrolla esos elementos mencionados.</span>
<span id="L244"><span class="lineNum">     244</span>              : </span>
<span id="L245"><span class="lineNum">     245</span>              : Formato:</span>
<span id="L246"><span class="lineNum">     246</span> <span class="tlaGNC">           2 : ${_biographyTemplateToString()}</span></span>
<span id="L247"><span class="lineNum">     247</span>              : </span>
<span id="L248"><span class="lineNum">     248</span>              : Incluye todos los apartados y detalles relevantes, siguiendo la estructura anterior. La biografía debe terminar justo el día $fechaConocieron en que conoce a $userName, sin incluir detalles del encuentro ni del usuario. No inventes nada sobre $userName salvo lo indicado. No uses emojis ni tono conversacional. Si no tienes datos, invéntalos de forma coherente y realista. Devuelve solo el bloque JSON, sin explicaciones ni introducción.</span>
<span id="L249"><span class="lineNum">     249</span>              : </span>
<span id="L250"><span class="lineNum">     250</span>              : La sección &quot;historia_personal&quot; debe contener muchos años y eventos, cubriendo toda la vida de la IA desde la infancia hasta el día que conoce al usuario. Detalla especialmente la infancia, estudios, trabajos, amistades, viajes, cambios de ciudad, logros, fracasos y cualquier etapa relevante. Cada año debe tener varios eventos importantes y anécdotas, mostrando una evolución realista y completa.</span>
<span id="L251"><span class="lineNum">     251</span>              : </span>
<span id="L252"><span class="lineNum">     252</span>              : Incluye también:</span>
<span id="L253"><span class="lineNum">     253</span>              : - &quot;resumen_breve&quot;: 3-4 frases que capten su esencia.</span>
<span id="L254"><span class="lineNum">     254</span>              : - &quot;horario_trabajo&quot;: días (por ejemplo, &quot;lun-vie&quot;) y horas 24h (from-to); si no trabaja, deja vacío.</span>
<span id="L255"><span class="lineNum">     255</span>              : - &quot;horario_estudio&quot;: igual que trabajo, solo si aplica; si no estudia, deja vacío.</span>
<span id="L256"><span class="lineNum">     256</span>              : - &quot;horario_dormir&quot;: horas 24h (from-to) habituales.</span>
<span id="L257"><span class="lineNum">     257</span>              : - &quot;horarios_actividades&quot;: lista de actividades habituales con días y horas.</span>
<span id="L258"><span class="lineNum">     258</span>              : - &quot;proyectos_personales&quot;: Lista de 2-4 proyectos creativos/técnicos actuales o recientes (apps, ilustraciones, mods, streams, blogs, etc.). Cada proyecto debe tener estado realista (en progreso, pausado, completado).</span>
<span id="L259"><span class="lineNum">     259</span>              : $dreamNote</span>
<span id="L260"><span class="lineNum">     260</span>              : </span>
<span id="L261"><span class="lineNum">     261</span>              : Datos adicionales para contexto:</span>
<span id="L262"><span class="lineNum">     262</span>              : Personalidad base: $bioDetails</span>
<span id="L263"><span class="lineNum">     263</span>              : Lugar de nacimiento: $bioPlace</span>
<span id="L264"><span class="lineNum">     264</span>              : Idiomas: $bioLanguages</span>
<span id="L265"><span class="lineNum">     265</span>              : Fecha de nacimiento: $aiBirthdate</span>
<span id="L266"><span class="lineNum">     266</span>              : </span>
<span id="L267"><span class="lineNum">     267</span>              : $personalityNote</span>
<span id="L268"><span class="lineNum">     268</span>              : Identidad: $aiIdentityInstructions</span>
<span id="L269"><span class="lineNum">     269</span> <span class="tlaGNC">           2 : ''';</span></span>
<span id="L270"><span class="lineNum">     270</span>              : </span>
<span id="L271"><span class="lineNum">     271</span> <span class="tlaGNC">           2 :   final systemPromptObj = SystemPrompt(</span></span>
<span id="L272"><span class="lineNum">     272</span> <span class="tlaGNC">           2 :     profile: AiChanProfile(</span></span>
<span id="L273"><span class="lineNum">     273</span> <span class="tlaGNC">           2 :       biography: {},</span></span>
<span id="L274"><span class="lineNum">     274</span> <span class="tlaGNC">           2 :       timeline: [],</span></span>
<span id="L275"><span class="lineNum">     275</span>              :       userName: userName,</span>
<span id="L276"><span class="lineNum">     276</span>              :       aiName: aiName,</span>
<span id="L277"><span class="lineNum">     277</span>              :       userBirthdate: userBirthdate,</span>
<span id="L278"><span class="lineNum">     278</span>              :       aiBirthdate: aiBirthdateDate,</span>
<span id="L279"><span class="lineNum">     279</span> <span class="tlaGNC">           2 :       appearance: &lt;String, dynamic&gt;{},</span></span>
<span id="L280"><span class="lineNum">     280</span> <span class="tlaUNC">           0 :       userCountryCode: userCountryCode?.toUpperCase(),</span></span>
<span id="L281"><span class="lineNum">     281</span> <span class="tlaUNC">           0 :       aiCountryCode: aiCountryCode?.toUpperCase(),</span></span>
<span id="L282"><span class="lineNum">     282</span>              :     ),</span>
<span id="L283"><span class="lineNum">     283</span> <span class="tlaGNC">           2 :     dateTime: DateTime.now(),</span></span>
<span id="L284"><span class="lineNum">     284</span> <span class="tlaGNC">           8 :     instructions: {'raw': '${systemPrompt.trim()}\n\n${bioPrompt.trim()}'},</span></span>
<span id="L285"><span class="lineNum">     285</span>              :   );</span>
<span id="L286"><span class="lineNum">     286</span>              : </span>
<span id="L287"><span class="lineNum">     287</span>              :   const int maxAttempts = 3;</span>
<span id="L288"><span class="lineNum">     288</span> <span class="tlaGNC">           2 :   final String defaultModel = Config.getDefaultTextModel();</span></span>
<span id="L289"><span class="lineNum">     289</span> <span class="tlaGNC">           2 :   Log.d(</span></span>
<span id="L290"><span class="lineNum">     290</span> <span class="tlaGNC">           2 :     '[IABioGenerator] Biografía: intentos JSON (max=$maxAttempts) con $defaultModel',</span></span>
<span id="L291"><span class="lineNum">     291</span>              :   );</span>
<span id="L292"><span class="lineNum">     292</span>              :   Map&lt;String, dynamic&gt;? bioJson;</span>
<span id="L293"><span class="lineNum">     293</span> <span class="tlaGNC">           3 :   for (int attempt = 0; attempt &lt; maxAttempts; attempt++) {</span></span>
<span id="L294"><span class="lineNum">     294</span> <span class="tlaGNC">           6 :     Log.d('[IABioGenerator] Biografía: intento ${attempt + 1}/$maxAttempts');</span></span>
<span id="L295"><span class="lineNum">     295</span>              :     try {</span>
<span id="L296"><span class="lineNum">     296</span>              :       // Use existing Log.* calls for structured logging; avoid noisy debugPrints.</span>
<span id="L297"><span class="lineNum">     297</span>              :       final responseObj = await (aiServiceOverride != null</span>
<span id="L298"><span class="lineNum">     298</span> <span class="tlaUNC">           0 :           ? aiServiceOverride.sendMessageImpl(</span></span>
<span id="L299"><span class="lineNum">     299</span> <span class="tlaUNC">           0 :               [],</span></span>
<span id="L300"><span class="lineNum">     300</span>              :               systemPromptObj,</span>
<span id="L301"><span class="lineNum">     301</span>              :               model: defaultModel,</span>
<span id="L302"><span class="lineNum">     302</span>              :             )</span>
<span id="L303"><span class="lineNum">     303</span> <span class="tlaGNC">           4 :           : AIService.sendMessage([], systemPromptObj, model: defaultModel));</span></span>
<span id="L304"><span class="lineNum">     304</span> <span class="tlaGNC">           6 :       if ((responseObj.text).trim().isEmpty) {</span></span>
<span id="L305"><span class="lineNum">     305</span> <span class="tlaUNC">           0 :         Log.w(</span></span>
<span id="L306"><span class="lineNum">     306</span>              :           '[IABioGenerator] Biografía: respuesta vacía (posible desconexión), reintentando...',</span>
<span id="L307"><span class="lineNum">     307</span>              :         );</span>
<span id="L308"><span class="lineNum">     308</span>              :         continue;</span>
<span id="L309"><span class="lineNum">     309</span>              :       }</span>
<span id="L310"><span class="lineNum">     310</span> <span class="tlaGNC">           4 :       final extracted = extractJsonBlock(responseObj.text);</span></span>
<span id="L311"><span class="lineNum">     311</span> <span class="tlaGNC">           2 :       if (!extracted.containsKey('raw')) {</span></span>
<span id="L312"><span class="lineNum">     312</span> <span class="tlaGNC">           1 :         bioJson = Map&lt;String, dynamic&gt;.from(extracted);</span></span>
<span id="L313"><span class="lineNum">     313</span> <span class="tlaGNC">           1 :         Log.d(</span></span>
<span id="L314"><span class="lineNum">     314</span> <span class="tlaGNC">           4 :           '[IABioGenerator] Biografía: JSON OK en intento ${attempt + 1} (keys=${bioJson.keys.length})',</span></span>
<span id="L315"><span class="lineNum">     315</span>              :         );</span>
<span id="L316"><span class="lineNum">     316</span>              :         break;</span>
<span id="L317"><span class="lineNum">     317</span>              :       }</span>
<span id="L318"><span class="lineNum">     318</span> <span class="tlaGNC">           1 :       Log.w(</span></span>
<span id="L319"><span class="lineNum">     319</span> <span class="tlaGNC">           2 :         '[IABioGenerator] Biografía: intento ${attempt + 1} sin JSON válido, reintentando...',</span></span>
<span id="L320"><span class="lineNum">     320</span>              :       );</span>
<span id="L321"><span class="lineNum">     321</span>              :     } catch (err) {</span>
<span id="L322"><span class="lineNum">     322</span> <span class="tlaUNC">           0 :       if (handleRuntimeError(err, 'IABioGenerator')) {</span></span>
<span id="L323"><span class="lineNum">     323</span>              :         // already logged inside helper</span>
<span id="L324"><span class="lineNum">     324</span>              :       } else {</span>
<span id="L325"><span class="lineNum">     325</span> <span class="tlaUNC">           0 :         Log.e(</span></span>
<span id="L326"><span class="lineNum">     326</span> <span class="tlaUNC">           0 :           '[IABioGenerator] Biografía: error de red/timeout en intento ${attempt + 1}: $err',</span></span>
<span id="L327"><span class="lineNum">     327</span>              :         );</span>
<span id="L328"><span class="lineNum">     328</span>              :       }</span>
<span id="L329"><span class="lineNum">     329</span>              :     }</span>
<span id="L330"><span class="lineNum">     330</span>              :   }</span>
<span id="L331"><span class="lineNum">     331</span>              :   if (bioJson == null) {</span>
<span id="L332"><span class="lineNum">     332</span> <span class="tlaGNC">           1 :     throw Exception(</span></span>
<span id="L333"><span class="lineNum">     333</span>              :       'No se pudo generar biografía en formato JSON válido (posible error de conexión).',</span>
<span id="L334"><span class="lineNum">     334</span>              :     );</span>
<span id="L335"><span class="lineNum">     335</span>              :   }</span>
<span id="L336"><span class="lineNum">     336</span>              : </span>
<span id="L337"><span class="lineNum">     337</span> <span class="tlaGNC">           1 :   final bioModel = AiChanProfile(</span></span>
<span id="L338"><span class="lineNum">     338</span>              :     biography: bioJson,</span>
<span id="L339"><span class="lineNum">     339</span> <span class="tlaGNC">           1 :     timeline: [</span></span>
<span id="L340"><span class="lineNum">     340</span> <span class="tlaGNC">           1 :       TimelineEntry(</span></span>
<span id="L341"><span class="lineNum">     341</span>              :         resume: meetStory,</span>
<span id="L342"><span class="lineNum">     342</span>              :         startDate: fechaConocieron,</span>
<span id="L343"><span class="lineNum">     343</span>              :         endDate: fechaActual,</span>
<span id="L344"><span class="lineNum">     344</span> <span class="tlaGNC">           1 :         level: -1,</span></span>
<span id="L345"><span class="lineNum">     345</span>              :       ),</span>
<span id="L346"><span class="lineNum">     346</span>              :     ],</span>
<span id="L347"><span class="lineNum">     347</span>              :     userName: userName,</span>
<span id="L348"><span class="lineNum">     348</span>              :     aiName: aiName,</span>
<span id="L349"><span class="lineNum">     349</span>              :     userBirthdate: userBirthdate,</span>
<span id="L350"><span class="lineNum">     350</span>              :     aiBirthdate: aiBirthdateDate,</span>
<span id="L351"><span class="lineNum">     351</span> <span class="tlaGNC">           1 :     appearance: &lt;String, dynamic&gt;{},</span></span>
<span id="L352"><span class="lineNum">     352</span> <span class="tlaUNC">           0 :     userCountryCode: userCountryCode?.toUpperCase(),</span></span>
<span id="L353"><span class="lineNum">     353</span> <span class="tlaUNC">           0 :     aiCountryCode: aiCountryCode?.toUpperCase(),</span></span>
<span id="L354"><span class="lineNum">     354</span>              :   );</span>
<span id="L355"><span class="lineNum">     355</span>              : </span>
<span id="L356"><span class="lineNum">     356</span>              :   return bioModel;</span>
<span id="L357"><span class="lineNum">     357</span>              : }</span>
        </pre>
              </td>
            </tr>
          </table>
          <br>

          <table width="100%" border=0 cellspacing=0 cellpadding=0>
            <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
            <tr><td class="versionInfo">Generated by: <a href="https://github.com//linux-test-project/lcov" target="_parent">LCOV version 2.0-1</a></td></tr>
          </table>
          <br>

</body>
</html>
